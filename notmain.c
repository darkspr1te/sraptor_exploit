#define STM32F1
#define STM32F103xB
#include "stm32f1xx.h"

uint32_t SystemCoreClock = 0;
void PUT32 ( unsigned int, unsigned int );
unsigned int GET32 ( unsigned int );
const uint32_t *mcuFirstPageAddr = (const uint32_t *) (0x8000000);

int notmain ( void )
{
	SystemCoreClock = 8000000;
	 RCC->APB1ENR  |=  ( RCC_APB1ENR_USART2EN );
    RCC->APB2ENR  |=  ( RCC_APB2ENR_IOPAEN );
    // Configure pins A2, A3 for USART2.
    GPIOA->CRL    &= ~( GPIO_CRL_MODE2 |
                        GPIO_CRL_CNF2 |
                        GPIO_CRL_MODE3 |
                        GPIO_CRL_CNF3 );
    GPIOA->CRL    |= ( ( 0x1 << GPIO_CRL_MODE2_Pos ) |
                       ( 0x2 << GPIO_CRL_CNF2_Pos ) |
                       ( 0x0 << GPIO_CRL_MODE3_Pos ) |
                       ( 0x1 << GPIO_CRL_CNF3_Pos ) );
					   
	RCC->APB1ENR  |=  ( RCC_APB1ENR_USART2EN );
    RCC->APB2ENR  |=  ( RCC_APB2ENR_IOPAEN );
    // Configure pins A2, A3 for USART2.
    GPIOA->CRL    &= ( GPIO_CRL_MODE2 |
                       GPIO_CRL_CNF2 |
                       GPIO_CRL_MODE3 |
                       GPIO_CRL_CNF3 );
    GPIOA->CRL    |= ( ( 0x1 << GPIO_CRL_MODE2_Pos ) |
                       ( 0x2 << GPIO_CRL_CNF2_Pos ) |
                       ( 0x0 << GPIO_CRL_MODE3_Pos ) |
                       ( 0x1 << GPIO_CRL_CNF3_Pos ) );
	uint16_t uartdiv = SystemCoreClock / 9600;
	USART2->BRR = ( ( ( uartdiv / 16 ) << USART_BRR_DIV_Mantissa_Pos ) |
                    ( ( uartdiv % 16 ) << USART_BRR_DIV_Fraction_Pos ) );
					
	USART2->CR1 |= ( USART_CR1_RE | USART_CR1_TE | USART_CR1_UE );

    unsigned int ra;
	uint32_t cnt;
	
    ra=GET32(0x20000400);
    PUT32(0x20000404,ra);
    PUT32(0x20000400,ra+1);
	cnt=0;
	
	 for (int addr=0x8000000;addr <= 0x803e800;addr++)
 {
	 USART2->DR = *((uint16_t*) addr );
	 while(!(USART2->SR & (1 << 6)));
 }
return (0);

	while(1)
	{
		//ra=GET32(0x08000000+cnt);
//ra=*mcuFirstPageAddr+cnt;
		ra=(*(mcuFirstPageAddr ) )+cnt;
		USART2->DR =ra;
		cnt=cnt+1;
		for (int xb=0;xb<100;xb++)
		{}
	}
    return(0);
}